/* -*- mode: groovy -*-
  Updating Docker image for https://castle-engine.io/convert.php using Jenkins.
  See https://castle-engine.io/jenkins for syntax of this file.
*/

pipeline {
  agent none // each stage has a particular agent

  // this builds + uploads a Docker image, do not upload 2 images in parallel
  options { disableConcurrentBuilds()  }

  triggers {
    /* Update automatically when cge-www repo changes, or castle-engine (Docker image) changes. */
    pollSCM('H/4 * * * *')
    upstream(upstreamProjects: 'castle_game_engine_organization/castle-engine-cloud-builds-tools/master', threshold: hudson.model.Result.SUCCESS)
  }

  stages {
    stage('Build Binaries with FPC') {
      // we need agent where FPC is installed
      agent {
        docker {
          image 'kambi/castle-engine-cloud-builds-tools:cge-none'
        }
      }
      steps {
        dir ("online-model-converter/docker-image/") {
          sh './build_fpc.sh'
          dir ("tmp/castle-model-viewer/") {
            // note that stash remembers (and later recreates) the relative dirs,
            // that is why we do this under "dir".
            stash name: 'binaries-made-by-fpc', includes: 'castle-model-viewer,castle-model-converter'
          }
        }
      }
    }
    stage('Build and Upload Docker Image') {
      // we need agent where Docker is installed
      agent {
        label 'jenkins-conv-x3d-docker-uploader'
      }
      steps {
        sh "rm -Rf online-model-converter/docker-image/docker-context/"
        sh "mkdir -p online-model-converter/docker-image/docker-context/bin/"
        dir ("online-model-converter/docker-image/docker-context/bin/") {
          unstash name: 'binaries-made-by-fpc'
        }
        dir ("online-model-converter/docker-image/") {
          sh './build_docker_1_build.sh'
          sh './build_docker_2_test.sh'
          withCredentials([
            string(credentialsId: 'docker-user', variable: 'docker_user'),
            string(credentialsId: 'docker-password', variable: 'docker_password')
          ]) {
            sh './build_docker_3_upload.sh'
          }
        }
        /* Make sure that on this host, we have latest Docker image available for future
           online-model-converter/online-model-converter.sh calls.
           Testcase:
           - ssh-cge
           - docker run --name test-conv --volume="${HOME}":/home/michalis/ --volume="${HOME}"/sources/:/home/michalis/sources/ -it kambi/online-model-converter bash
           - test tovrmlx3d inside
           - later: docker stop test-conv && docker rm test-conv
        */
        sh 'docker pull kambi/online-model-converter'
      }
    }
  }
  post {
    regression {
      mail to: 'michalis@castle-engine.io',
        subject: "[jenkins] Build started failing: ${currentBuild.fullDisplayName}",
        body: "See the build details on ${env.BUILD_URL}"
    }
    failure {
      mail to: 'michalis@castle-engine.io',
        subject: "[jenkins] Build failed: ${currentBuild.fullDisplayName}",
        body: "See the build details on ${env.BUILD_URL}"
    }
    fixed {
      mail to: 'michalis@castle-engine.io',
        subject: "[jenkins] Build is again successful: ${currentBuild.fullDisplayName}",
        body: "See the build details on ${env.BUILD_URL}"
    }
  }
}
